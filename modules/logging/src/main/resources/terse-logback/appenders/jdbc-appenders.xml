<included>

    <!-- ringbuffer is in memory, so don't put too much in -->
    <ringBuffer name="JDBC_RINGBUFFER">
        <capacity>${jdbc.ringBuffer.capacity}</capacity>
    </ringBuffer>

    <appender name="ASYNC_JDBC" class="net.logstash.logback.appender.LoggingEventAsyncDisruptorAppender">
        <ringBufferSize>${jdbc.appenderRingBufferSize}</ringBufferSize>

        <!--
          A JDBC appender that adds the correlation id as a field.
        -->
        <appender class="com.tersesystems.logback.correlationid.CorrelationIdJDBCAppender">
            <driver>${jdbc.driver}</driver>
            <url>${jdbc.url}</url>
            <username>${jdbc.username}</username>
            <password>${jdbc.password}</password>

            <include resource="terse-logback/encoders/json-encoder.xml"/>

            <createStatements>${jdbc.createStatements}</createStatements>
            <insertStatement>${jdbc.insertStatement}</insertStatement>
            <reaperStatement>${jdbc.reaperStatement}</reaperStatement>
            <reaperSchedule>${jdbc.reaperSchedule}</reaperSchedule>
        </appender>
    </appender>

    <!--
      A ring buffer aware appender may send events to a ring buffer or through to another appender.
    -->
    <appender name="ASYNC_JDBC_WITH_RINGBUFFER" class="com.tersesystems.logback.ringbuffer.RingBufferAwareAppender">
        <!-- log to jdbc if INFO or above, otherwise log to ring buffer -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>${jdbc.threshold}</level>
        </filter>

        <!-- anything denied goes to the ring buffer -->
        <ringBuffer-ref ref="JDBC_RINGBUFFER"/>

        <!-- anything accepted goes to the appender, which has a wrapper for dealing with dumps -->
        <appender-ref ref="ASYNC_JDBC"/>
    </appender>

    <!--
      This logger is the handle for dumping the ring buffer.
    -->
    <logger name="JDBC_RINGBUFFER_LOGGER" level="TRACE" additivity="false">
        <!-- This appender dumps contents of the ring buffer when an event is received. -->
        <appender class="com.tersesystems.logback.ringbuffer.DumpRingBufferAppender">
            <!-- Event source -->
            <ringBuffer-ref ref="JDBC_RINGBUFFER"/>

            <!-- Event source -->
            <appender-ref ref="ASYNC_JDBC"/>
        </appender>
    </logger>

</included>